# 12. 타입스크립트 프로젝트 관리

## 12.1 앰비언트 타입 활용하기

### 1. 앰비언트 타입 선언

타입스크립트의 타입 선언은 `.ts`, `.tsx` 확장자를 가진 파일에서 할 수 있지만 `.d.ts` 확장자를 가진 파일에서도 선언할수 있다.

#### 앰비언트 타입 선언

`.d.ts` 확장자를 가진 파일에서는 타입 선언만 할 수 있고 값을 표현할 수는 없다. 값을 포함하는 일반적인 선언과 구별하기 위해서 `.d.ts` 확장자를 가진 파일에서 선언하는 타입을 앰비언트 타입 선언이라고 부른다.

> 앰비언트(ambient)는 사전적으로 '주변의'란 의미이다.

`declare`라는 키워드를 사용하여 어딘가에 자바스크립트 값이 존재한다는 사실을 알려줄 수 있다.

> `declare`는 타입스크립트 컴파일러에 어떤 것의 존재 여부를 명시해주는 역할을 한다. 단순히 존재 여부만 알려주기 때문에 컴파일 대상이 아니다.

#### 대표적인 앰비언트 타입 선언 활용 사례

타입스크립트는 기본적으로 `.ts`, `.js` 파일만 이해하며 그 외의 다른 파일 형식은 인식 못한다. 알지 못하는 파일 형식을 모듈로 가져오려 하면 에러가 난다. 이럴 때 `declare` 키워드를 사용하여 타입을 선언하면 에러가 나지 않는다.

```ts
declare module "*.png" {
  const src: string;
  export default src;
}
```

위 코드는 png 파일을 모듈로 가져올 때 타입을 선언한 것이다. 이렇게 선언하면 타입스크립트 컴파일러가 png 파일을 모듈로 인식하게 된다.

#### 자바스크립트로 작성된 라이브러리

자바스크립트로 작성된 npm 라이브러리를 사용할 때 타입 선언이 없어 임포트한 모듈을 모두 `any`로 추론될 것이다. 이때 앰비언트 타입 선언을 사용하여 타입 정보를 추가할 수 있다.

앰비언트 타입 선언은 타입스크립트에게 '자바스크립트 코드 안에는 이러한 정보들이 있어'라고 알려주는 도구라고 이해하면 된다.

#### 타입스크립트로 작성된 라이브러리

라이브러리를 사용 중인 타입스크립트 파일을 컴파일 할 때 라이브러리 코드도 함께 컴파일하게 할 수도 있다. 그러나 자바스크립트 파일과 `.d.ts` 파일로 배포하면 라이브러리 코드를 따로 컴파일하지 않아도 되기 때문에 컴파일 시간이 크게 줄어든다.

또한 `.d.ts` 파일이 있기 때문에 사용자가 `.d.ts` 파일에 정의된 타입 정보를 활용하여 라이브러리를 사용할 수 있다.

`tsconfig.json` 파일의 `declaration` 옵션을 `true`로 설정하면 타입스크립트 컴파일러가 자동으로 `.d.ts` 파일을 생성한다.

```json
{
  "compilerOptions": {
    "declaration": true
  }
}
```

#### 자바스크립트 어딘가에 전역 변수가 정의되어 있음을 타입스크립트에 알릴 때

타입스크립트로 직접 구현하지 않았지만 실제 자바스크립트 어딘가에 전역 변수가 정의되어 있는 상황을 타입스크립트에 알릴 때 앰비언트 타입 선언을 사용한다.

예로 웹뷰를 개발할 때 `Window` 객체에 네이티브 앱과의 통신을 위한 인터페이스를 추가하는 경우가 많다. 네이티브 앱에서 `Window` 전역 객체에 `deviceId`나 `appVersion` 같은 값을 할당해주는 시나리오가 있다고 가정하자. 이때 타입스크립트는 `Window` 객체에 `deviceId`나 `appVersion`이라는 프로퍼티가 없다고 에러를 표시할 것이다. 이럴 때 앰비언트 타입 선언을 사용하여 `Window` 객체에 `deviceId`나 `appVersion`이라는 프로퍼티가 있다고 타입스크립트에 알려줄 수 있다.

```ts
declare global {
  interface Window {
    deviceId: string | undefined;
    appVersion: string;
  }
}
```

### 2. 앰비언트 타입 선언 시 주의점

#### 타입스크립트로 만드는 라이브러리에는 불필요

`tsconfig.json`의 `declaration`을 `true`로 설정하면 타입스크립트 컴파일러가 자동으로 `.d.ts` 파일을 생성해주기 때문에 타입스크립트로 만드는 라이브러리에는 앰비언트 타입 선언을 사용할 필요가 없다.

#### 전역으로 타입을 정의하여 사용할 때 주의해야 할 점

서로 다른 라이브러리에 동일한 이름의 앰비언트 타입 선언을 한다면 충돌이 발생하여 어떤 타입 선언이 적용될지 알 수 없다.

### 3. 앰비언트 타입 선언을 잘못 사용했을 때의 문제점

`.ts` 파일 내의 앰비언트 변수 선언은 개발자에게 혼란을 야기할 수 있다. 앰비언트 타입은 명시적인 임포트나 익스포트 없이 코드 전역에서 사용할 수 있기 때문에 의존성 관계가 보이지 않아 변경에 의한 영향 범위를 파악하기 어렵다. 소스코드 규모가 크다면 추후 변경이 어려워질 수 있다.

`.ts`, `.tsx` 파일 내에서 `declare` 키워드를 사용해 앰비언트 타입 선언이 가능하다.

```ts
// src/index.tsx
import React from "react";
import ReactDOM from "react-dom";
import App from "./App";

declare global {
  interface Window {
    Example: string;
  }
}

const SomeComponent = () => {
  return <div>앰비언트 타입 선언은 .tsx 파일에서도 가능</div>;
};

// src/test.tsx
window.Example; // 앰비언트 타입 선언으로 인해 타입스크립트 에러가 발생하지 않는다.
```

이렇듯 어느 곳에서나 앰비언트 변수 선언이 가능하기 때문에 .d.ts 파일 내에서 앰비언트 타입 선언을 하는 것이 일종의 개발자 간의 약속이다. 타입 선언 위치가 명확해야 가독성이 높아지고 유지보수도 쉬워진다.

### 4. 앰비언트 타입 활용하기

컴파일러에 타입 정보를 알려주는 `declare` 키워드를 효과적으로 활용해보자.

#### 타입을 정의하여 임포트 없이 전역으로 공유

`.d.ts` 파일에 앰비언트 타입 선언은 전역 변수와 같은 역할을 한다. 모든 코드 내에서 임포트하지 않고 사용할 수 있다. 예를 들어 유틸리티 타입을 선언하면 마치 내장 타입 유틸리티 함수를 사용하는 것처럼 사용할 수 있다.

```typescript
// src.index.d.ts
type Optionl<T extends object, K extends keyof T = keyof T> = Omit<T, K> &
  Partial<Pick<T, K>>;

// src/components.ts
type Props = { name: string; age: number; visible: boolean };
type OptionalProps = Optional<Props>; // Expect: { name?: string; age?: number; visible?: boolean; }
```

**_보충 예시_**

```ts
type Example = {
  a: string;
  b: number;
  c: boolean;
};

type OptionalExample = Optional<Example, "a" | "b">;

// OptionalExample 타입은 다음과 같다:
// {
//   c: boolean;
//   a?: string;
//   b?: number;
// }
```

#### declare type 활용하기

보편적으로 사용하는 커스텀 유틸리티 타입을 `declare type`으로 선언해 전역에서 사용할 수 있다.

```typescript
// Nullable
declare type Nullable<T> = T | null;

const name: Nullable<string> = "woowa";
```

#### declare module 활용하기

CSS-in-JS 라이브러리에서 theme 인터페이스 타입을 확장하여 theme 타입이 자동으로 완성되도록 하는 기능이 추가되었다.

```tsx
const fontSizes = {
  xl: "24px",
  // ...
};

const colors = {
  gray_100: "#222222",
  gray_200: "#444444",
  // ...
};

const theme = {
  fontSizes,
  colors,
};

declare module "styled-components" {
  type Theme = typeof theme;

  export interface DefaultTheme extends Theme {}
}
```

#### declare namespace 활용하기

`.env` 파일을 사용할 때, `declare namespace을` 활용해 `process.env`로 설정값을 손쉽게 불러오고 환경변수의 자동 완성 기능을 쓸 수 있다.

```ts
declare namespace NodeJS {
  interface ProcessEnv {
    readonly API_URL: string;
    readonly API_INTERNAL_URL: string;
    // ...
  }
}
```

#### declare global 활용하기

전역 변수를 선언할 때 사용한다. 예를 들어 Window 객체에 전역 변수를 추가할 때 사용한다.

```ts
declare global {
  interface Window {
    newProperty: string;
  }
}
```

iOS 웹뷰에서 자바스크립트로 네이티브 함수를 호출하기 위한 함수를 정의해보자.

```ts
declare global {
  interface Window {
    webkit?: {
      messageHandlers?: Record<
        string,
        { postMessage?: (parameter: string) => void }
      >;
    };
  }
}
```

### 5. declare와 번들러의 시너지

`declare global`로 전역 변수를 선언하는 과정과 번들러를 통해 데이터를 주입하는 절차를 함께 활용하면 좋다. 아래 코드에서 color를 번들러를 통해 주입하고, `_color` 데이터를 사용할 수 있다. 이 과정을 하지 않는다면, `_color` 객체의 실제 데이터가 존재하지 않는다. 타입스크립트 에러가 발생하지는 않지만 기대하는 동작과 다를 수 있다.

```ts
// data.ts
const color = {
  red: "#ff0000",
  green: "#00ff00",
  blue: "#0000ff",
} as const;

// type.ts
import { color } from "./data";
type ColorSet = typeof color;

declare global {
  const _color: ColorSet;
}

// index.ts
console.log(_color["red"]); // #ff0000

// rollup.config.js
import typescript from "@rollup/plugin-typescript";
import inject from "@rollup/plugin-inject";

export default [
  {
    input: "index.ts",
    output: [
      {
        dir: "lib",
        format: "esm",
      },
    ],
    plugins: [typescript(), inject({ _color: ["./data", "color"] })],
  },
];
```

```ts
const red = _color["red"]; // 정상 동장
```

## 12.2 스크립트와 설정 파일 활용하기

스크립트와 `tsconfig` 등을 활용하여 타입스크립트 프로젝트를 관리하는 방법을 알아보자.

### 1. 스크립트 활용하기

#### 실시간으로 타입을 검사하자

아래 스크립트를 사용하면 실시간으로 에러를 확인할 수 있다.

```bash
yarn tsc --noEmit --incremental -w
```

**설명**

- `tsc` 명령어는 타입스크립트 컴파일러를 실행하는 명령어이다.
- `--noEmit` 옵션은 컴파일 결과물을 생성하지 않는 옵션이다.
- `--incremental` 옵션은 타입스크립트 컴파일러가 이전 컴파일 결과물을 재사용하여 컴파일 속도를 높이는 옵션이다.
- `-w` 옵션은 파일을 감시하고 변경사항이 있을 때마다 컴파일을 실행하는 옵션이다.

#### 타입 커버리지 확인하기

`any`를 남발하면 타입스크립트를 사용하는 의미가 없어진다. 타입스크립트로 작성된 코드 중 `any`를 사용한 코드의 비율을 확인하고 줄여나가는 것이 중요하다.

```bash
npx type-coverage --detail
```

이 스크립트를 사용하면 현재 프로젝트의 타입 커버리지와 `any`를 사용하고 있는 변수의 위치가 나타난다. 또한 변수에 타입이 얼마나 지정되어 있는지 퍼센트로 확인할 수 있다.

### 2. 설정 파일 활용하기

#### 타입스크립트 컴파일 속도 높이기

`tsconfig.json` 파일에 `incremental` 옵션을 추가하면 증분 컴파일이 활성화되어 매번 모든 대상을 컴파일하는 것이 아니라 변경된 부분만 컴파일하게 된다. 타입스크립트 컴파일 속도를 높일 수 있다.

- `tsconfig.json` 파일에 설정 추가

  ```json
  {
    "compilerOptions": {
      "incremental": true
      // ...
    }
  }
  ```

- 스크립트 활용
  ```bash
  yarn tsc --noEmit --incremental --diagnostic
  ```

### 3. 에디터 활용하기

가끔 IDE에서 타입 자동 완성 기능이 동작하지 않는 경우, 타입스크립트 서버를 재실행하면 된다. VSCode에서 `Restart TS server` 명령어를 실행하면 된다. (Cmd + Shift + P)
